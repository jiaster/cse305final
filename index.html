<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CSE 305 Projet</title>
    <link rel='stylesheet' href='//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css'>
    <link rel='stylesheet' href='//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css'>
    <link rel="stylesheet" href="./style.css" type="text/css" />
    <script>
        window.console = window.console || function (t) { };
    </script>
</head>

<body translate="no">
    <div class="container">
        <form id="changeUser">
            Userid: <input id="user" type="text">
            <input type="submit">
        </form>
        <p>Logged in as:</p>
        <p id="userid"></p>
        <h1>ITEMS:</h1>
        <div id="itemstable">
        </div>
        <h1>CART:</h1>
        <div id="cart">
        </div>
        <h1>ORDERS:</h1>
        <div id="orders">
        </div>
    </div>
    <button id="export-btn" class="btn btn-primary">Export Data</button>
    <p id="export"></p>
    </div>
    <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js'></script>
    <script src='https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore.js'></script>
    <script src="tables.js"></script>
    <link href="tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="tabulator.min.js"></script>
    <script type="text/javascript">
        //sample data
        const url = window.location.origin;
        var user = 0;
        var cart;
        var orders;

        var itemstable = new Tabulator("#itemstable", {
            height: 200,
            layout: "fitColumns", //fit columns to width of table (optional)
            columns: [ //Define Table Columns
                { title: "Name", field: "Name", sorter: "string" },
                { title: "Brand", field: "Brand", sorter: "string", sortable: true },
                { title: "Category", field: "Category", sorter: "string" },
                { title: "Price", field: "Price", sorter: "number", sortable: true }

            ],
            rowClick: function (e, id, data, row) {
                console.log(id);
            },
        });
        var carttable = new Tabulator("#cart", {
            height: 200,
            layout: "fitColumns", //fit columns to width of table (optional)
            columns: [ //Define Table Columns
                { title: "Name", field: "Name", sorter: "string" },
                { title: "Unit Price", field: "Price", sorter: "number" },
                { title: "Quantity", field: "Quantity", sorter: "number" },
                { title: "Total", field: "Total", sorter: "number" }
            ],
            rowClick: function (e, id, data, row) {
                console.log(id);
            },
        });
        var orderstable = new Tabulator("#orders", {
            height: 200,
            layout: "fitColumns", //fit columns to width of table (optional)
            columns: [ //Define Table Columns
                { title: "Order ID", field: "OrderID", sorter: "number" },
                { title: "Date", field: "Date", sorter: "date" },
                { title: "Total", field: "Total", sorter: "number" },
                { title: "Status", field: "Status", sorter: "string" }
            ],
            rowClick: function (e, id, data, row) {
                console.log(id);
            },
        });

        $('#changeUser').submit(() => {
            user = $('#user').val();
            console.log(/^\+?(0|[1-9]\d*)$/.test($('#user').val()));
            if (/^\+?(0|[1-9]\d*)$/.test(user) == true) {//if integer
                user = $('#user').val();
                console.log(`user set to ${user}`);
                $('#userid').text(user);
                //changeUsers();//TODO
                const cartURL = `${url}/cart/${user}`;
                console.log(cartURL);
                fetch(cartURL)//get cart
                    .then(data => { return data.json() })
                    .then(res => {
                        var count = 0;
                        cart = res["cart"];
                        cart.forEach((item) => {
                            const itemURL = `${url}/items/${item.Item}`;
                            fetch(itemURL)
                                .then(data => { return data.json() })
                                .then(res => {
                                    //console.log(res);
                                    item.Price = res["cart"][0].Price;
                                    item.Name = res["cart"][0].Name;
                                    item.Total = res["cart"][0].Quantity * res["cart"][0].Price;
                                    carttable.setData(cart);
                                });
                        });
                    })
                //calculate totals

                const getOrderURL = `${url}/customer/orders/${user}`;
                //var data;// = { id: user };
                //console.log(data);
                fetch(getOrderURL)//get orders
                    .then(data => { return data.json() })
                    .then(res => {
                        console.log(res);
                        orders = res["orders"];
                        orderstable.setData(orders);
                    })

                const getCustomerInfo = `${url}/customer/${user}`;
                fetch(getCustomerInfo)//get orders
                    .then(data => { return data.json() })
                    .then(res => {
                        console.log(res);
                        //orders = res["orders"];
                        //orderstable.setData(orders);
                    })
                    
                return false;
            } else {
                return false;
            }
        });



        const itemURL = `${url}/items`;
        var items;
        console.log(itemURL);
        fetch(itemURL)
            .then(data => { return data.json() })
            .then(res => {
                items = res["items"];
                console.log(items);
                itemstable.setData(items);
            });


    </script>
</body>

</html>